services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - '${BACKEND_PORT:-8080}:8080'
      - '${GRPC_PORT:-50051}:50051'
    environment:
      - GIN_MODE=${GIN_MODE:-debug}
      - DATABASE_TYPE=${DATABASE_TYPE:-sqlite}
      - VIEWRA_DATA_DIR=/app/viewra-data
      - VIEWRA_TRANSCODING_DIR=/viewra-data/transcoding
      - VIEWRA_DATABASE_PATH=${VIEWRA_DATABASE_PATH:-/app/viewra-data/viewra.db}
      - VIEWRA_PLUGIN_DIR=/app/data/plugins
      - PORT=8080
      - PLUGIN_DIR=/app/data/plugins
      - TMDB_API_KEY=${TMDB_API_KEY:-}
    volumes:
      # Runtime data and database
      - ./viewra-data:/app/viewra-data
      # Plugin data directory (for external plugins)
      - ./viewra-data/plugins:/app/data/plugins
      # Media directories
      - /cifs/fictionalserver/music:/media/music:ro
      - /cifs/fictionalserver/tv:/media/tv:ro
      - /cifs/fictionalserver/movies:/media/movies:ro
    networks:
      - viewra-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - '${FRONTEND_PORT:-5175}:5173'
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8080}
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - viewra-network
    restart: unless-stopped

  sqliteweb:
    image: coleifer/sqlite-web:latest
    ports:
      - '${SQLITEWEB_PORT:-8081}:8080'
    volumes:
      - ./viewra-data:/data
    command: ['sqlite_web', '/data/viewra.db', '--host', '0.0.0.0', '--port', '8080']
    networks:
      - viewra-network
    restart: unless-stopped
    profiles:
      - dev
      - all

volumes:
  backend-data:
  frontend-node-modules:

networks:
  viewra-network:
    driver: bridge