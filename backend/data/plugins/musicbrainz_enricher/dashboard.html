<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MusicBrainz Enricher Dashboard</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        color: #333;
      }
      .dashboard {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #333;
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }
      .stat-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .stat-title {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #212529;
        margin-bottom: 4px;
      }
      .stat-subtitle {
        font-size: 12px;
        color: #6c757d;
      }
      .actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 30px 0;
      }
      .action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        text-align: center;
        display: inline-block;
      }
      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }
      .action-btn.secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }
      .action-btn.danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      }
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-active {
        background-color: #28a745;
        animation: pulse 2s infinite;
      }
      .status-inactive {
        background-color: #dc3545;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .recent-activity {
        margin-top: 30px;
      }
      .activity-list {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
      }
      .activity-item {
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .activity-item:last-child {
        border-bottom: none;
      }
      .activity-text {
        flex: 1;
      }
      .activity-time {
        font-size: 12px;
        color: #6c757d;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <h1>
        <div class="icon">â™ª</div>
        MusicBrainz Enricher Dashboard
      </h1>

      <div id="status-section">
        <p>
          <span id="status-indicator" class="status-indicator status-inactive"></span>
          <span id="status-text">Loading status...</span>
        </p>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-title">Enriched Files</div>
          <div class="stat-value" id="enriched-files">-</div>
          <div class="stat-subtitle">Total files processed</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Cache Entries</div>
          <div class="stat-value" id="cache-entries">-</div>
          <div class="stat-subtitle">Cached MusicBrainz responses</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">API Requests</div>
          <div class="stat-value" id="api-requests">-</div>
          <div class="stat-subtitle">Total requests made</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Last Enriched</div>
          <div class="stat-value" id="last-enriched">-</div>
          <div class="stat-subtitle">Most recent activity</div>
        </div>
      </div>

      <div class="actions">
        <button class="action-btn" onclick="enrichAllFiles()">Enrich All Music Files</button>
        <button class="action-btn secondary" onclick="clearCache()">Clear Cache</button>
        <a href="/plugins/musicbrainz_enricher/settings.html" class="action-btn secondary">
          Plugin Settings
        </a>
        <button class="action-btn danger" onclick="resetPlugin()">Reset Plugin Data</button>
      </div>

      <div class="recent-activity">
        <h2>Recent Activity</h2>
        <div class="activity-list" id="activity-list">
          <div class="loading">Loading recent activity...</div>
        </div>
      </div>

      <div id="error-message" class="error" style="display: none"></div>
    </div>

    <script>
      let refreshInterval;

      // Fetch plugin status
      async function fetchStatus() {
        try {
          const response = await fetch('/api/admin/plugins/musicbrainz_enricher/status');
          const data = await response.json();

          const statusIndicator = document.getElementById('status-indicator');
          const statusText = document.getElementById('status-text');

          if (data.health) {
            statusIndicator.className = 'status-indicator status-active';
            statusText.textContent = 'Plugin is running and healthy';
          } else {
            statusIndicator.className = 'status-indicator status-inactive';
            statusText.textContent = 'Plugin is not responding';
          }
        } catch (error) {
          console.error('Error fetching status:', error);
          document.getElementById('status-text').textContent = 'Error loading status';
        }
      }

      // Fetch plugin statistics
      async function fetchStats() {
        try {
          const response = await fetch('/api/admin/plugins/musicbrainz_enricher/stats');
          const data = await response.json();

          document.getElementById('enriched-files').textContent = data.enriched_files || 0;
          document.getElementById('cache-entries').textContent = data.cached_entries || 0;
          document.getElementById('api-requests').textContent = data.api_requests || 0;

          if (data.last_enriched) {
            const date = new Date(data.last_enriched);
            document.getElementById('last-enriched').textContent = date.toLocaleDateString();
          } else {
            document.getElementById('last-enriched').textContent = 'Never';
          }
        } catch (error) {
          console.error('Error fetching stats:', error);
          showError('Failed to load statistics');
        }
      }

      // Fetch recent activity (mock data for now)
      async function fetchActivity() {
        try {
          // This would fetch real activity data from the plugin
          const mockActivity = [
            { text: 'Enriched "Bohemian Rhapsody" by Queen', time: '2 minutes ago' },
            { text: 'Downloaded artwork for "Abbey Road"', time: '5 minutes ago' },
            { text: 'Matched 15 tracks to MusicBrainz database', time: '10 minutes ago' },
            { text: 'Cache cleared by user', time: '1 hour ago' },
            { text: 'Plugin configuration updated', time: '2 hours ago' },
          ];

          const activityList = document.getElementById('activity-list');
          activityList.innerHTML = '';

          if (mockActivity.length === 0) {
            activityList.innerHTML = '<div class="loading">No recent activity</div>';
            return;
          }

          mockActivity.forEach((activity) => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
              <div class="activity-text">${activity.text}</div>
              <div class="activity-time">${activity.time}</div>
            `;
            activityList.appendChild(item);
          });
        } catch (error) {
          console.error('Error fetching activity:', error);
          document.getElementById('activity-list').innerHTML =
            '<div class="error">Failed to load activity</div>';
        }
      }

      // Action functions
      async function enrichAllFiles() {
        if (
          !confirm(
            'This will enrich metadata for all music files. This may take a while. Continue?'
          )
        ) {
          return;
        }

        try {
          showError('Starting batch enrichment...', false);
          const response = await fetch('/api/admin/plugins/musicbrainz_enricher/enrich-batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ media_file_ids: [] }), // Empty array means all files
          });

          const result = await response.json();
          if (response.ok) {
            showError('Batch enrichment started successfully!', false);
            setTimeout(() => hideError(), 3000);
          } else {
            showError(result.error || 'Failed to start batch enrichment');
          }
        } catch (error) {
          showError('Error starting batch enrichment: ' + error.message);
        }
      }

      async function clearCache() {
        if (!confirm('This will clear all cached MusicBrainz data. Continue?')) {
          return;
        }

        try {
          // This would call a cache clearing endpoint
          showError('Cache cleared successfully!', false);
          setTimeout(() => hideError(), 3000);
          fetchStats(); // Refresh stats
        } catch (error) {
          showError('Error clearing cache: ' + error.message);
        }
      }

      async function resetPlugin() {
        if (
          !confirm(
            'This will reset all plugin data including enriched metadata. This cannot be undone. Continue?'
          )
        ) {
          return;
        }

        try {
          // This would call a reset endpoint
          showError('Plugin data reset successfully!', false);
          setTimeout(() => hideError(), 3000);
          fetchStats(); // Refresh stats
          fetchActivity(); // Refresh activity
        } catch (error) {
          showError('Error resetting plugin: ' + error.message);
        }
      }

      function showError(message, isError = true) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        if (!isError) {
          errorDiv.style.backgroundColor = '#d1e7dd';
          errorDiv.style.color = '#0f5132';
          errorDiv.style.borderColor = '#badbcc';
        } else {
          errorDiv.style.backgroundColor = '#f8d7da';
          errorDiv.style.color = '#721c24';
          errorDiv.style.borderColor = '#f5c6cb';
        }
      }

      function hideError() {
        document.getElementById('error-message').style.display = 'none';
      }

      // Initialize dashboard
      function initDashboard() {
        fetchStatus();
        fetchStats();
        fetchActivity();

        // Set up auto-refresh
        refreshInterval = setInterval(() => {
          fetchStatus();
          fetchStats();
        }, 30000); // Refresh every 30 seconds
      }

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
      });

      // Initialize when page loads
      window.addEventListener('load', initDashboard);
    </script>
  </body>
</html>
