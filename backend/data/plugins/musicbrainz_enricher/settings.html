<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MusicBrainz Enricher Settings</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        color: #333;
      }
      .settings {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
      }
      h1 {
        color: #333;
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }
      .form-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .form-section h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #495057;
        font-size: 18px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
      }
      .label-description {
        font-size: 12px;
        color: #6c757d;
        font-weight: normal;
        margin-top: 2px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .checkbox-group input {
        width: auto;
        margin: 0;
      }
      .range-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .range-group input[type='range'] {
        flex: 1;
      }
      .range-value {
        min-width: 60px;
        text-align: center;
        font-weight: 500;
        color: #495057;
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }
      .button-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }
      .success-message,
      .error-message {
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        font-weight: 500;
      }
      .success-message {
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
      }
      .error-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info-box {
        background-color: #cff4fc;
        color: #055160;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #b6effb;
        margin-bottom: 20px;
      }
      .info-box strong {
        display: block;
        margin-bottom: 5px;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="settings">
      <h1>
        <div class="icon">âš™</div>
        MusicBrainz Enricher Settings
      </h1>

      <div class="info-box">
        <strong>About MusicBrainz Enricher</strong>
        This plugin enriches your music metadata using the MusicBrainz database and downloads
        artwork from the Cover Art Archive. Configure the settings below to customize how the
        enrichment process works.
      </div>

      <form id="settings-form">
        <!-- General Settings -->
        <div class="form-section">
          <h2>General Settings</h2>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="enabled" name="enabled" />
              <label for="enabled">
                Enable MusicBrainz Enrichment
                <div class="label-description">
                  Enable automatic metadata enrichment using MusicBrainz
                </div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="auto_enrich" name="auto_enrich" />
              <label for="auto_enrich">
                Auto-Enrich New Files
                <div class="label-description">
                  Automatically enrich metadata for newly scanned files
                </div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="overwrite_existing" name="overwrite_existing" />
              <label for="overwrite_existing">
                Overwrite Existing Metadata
                <div class="label-description">
                  Overwrite existing metadata with MusicBrainz data
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- API Settings -->
        <div class="form-section">
          <h2>API Settings</h2>

          <div class="form-group">
            <label for="user_agent">
              User Agent
              <div class="label-description">User agent string for MusicBrainz API requests</div>
            </label>
            <input
              type="text"
              id="user_agent"
              name="user_agent"
              placeholder="Viewra/1.0.0 (https://github.com/viewra/viewra)"
            />
          </div>

          <div class="form-group">
            <label for="api_rate_limit">
              API Rate Limit (requests/second)
              <div class="label-description">
                Rate limit for MusicBrainz API requests (max 1.0 for anonymous)
              </div>
            </label>
            <div class="range-group">
              <input
                type="range"
                id="api_rate_limit"
                name="api_rate_limit"
                min="0.1"
                max="1.0"
                step="0.1"
              />
              <div class="range-value" id="rate_limit_value">0.8</div>
            </div>
          </div>

          <div class="form-group">
            <label for="cache_duration_hours">
              Cache Duration (hours)
              <div class="label-description">How long to cache MusicBrainz responses</div>
            </label>
            <input
              type="number"
              id="cache_duration_hours"
              name="cache_duration_hours"
              min="1"
              max="8760"
            />
          </div>
        </div>

        <!-- Matching Settings -->
        <div class="form-section">
          <h2>Matching Settings</h2>

          <div class="form-group">
            <label for="match_threshold">
              Match Threshold
              <div class="label-description">
                Minimum similarity score for automatic matching (0.5-1.0)
              </div>
            </label>
            <div class="range-group">
              <input
                type="range"
                id="match_threshold"
                name="match_threshold"
                min="0.5"
                max="1.0"
                step="0.05"
              />
              <div class="range-value" id="threshold_value">0.85</div>
            </div>
          </div>
        </div>

        <!-- Artwork Settings -->
        <div class="form-section">
          <h2>Artwork Settings</h2>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="enable_artwork" name="enable_artwork" />
              <label for="enable_artwork">
                Enable Artwork Download
                <div class="label-description">Download album artwork from Cover Art Archive</div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="artwork_max_size">
              Max Artwork Size (pixels)
              <div class="label-description">Maximum artwork size to download</div>
            </label>
            <input
              type="number"
              id="artwork_max_size"
              name="artwork_max_size"
              min="250"
              max="2000"
            />
          </div>

          <div class="form-group">
            <label for="artwork_quality">
              Artwork Quality
              <div class="label-description">Preferred artwork quality</div>
            </label>
            <select id="artwork_quality" name="artwork_quality">
              <option value="front">Front Cover</option>
              <option value="back">Back Cover</option>
              <option value="booklet">Booklet</option>
              <option value="medium">Medium</option>
              <option value="obi">Obi</option>
              <option value="spine">Spine</option>
              <option value="track">Track</option>
              <option value="liner">Liner Notes</option>
              <option value="sticker">Sticker</option>
              <option value="poster">Poster</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button type="submit" id="save-btn">Save Settings</button>
          <button type="button" class="button-secondary" onclick="resetToDefaults()">
            Reset to Defaults
          </button>
          <button type="button" class="button-secondary" onclick="testConnection()">
            Test MusicBrainz Connection
          </button>
        </div>
      </form>

      <div id="message"></div>
    </div>

    <script>
      // Default configuration
      const defaultConfig = {
        enabled: true,
        api_rate_limit: 0.8,
        user_agent: 'Viewra/1.0.0 (https://github.com/viewra/viewra)',
        enable_artwork: true,
        artwork_max_size: 1200,
        artwork_quality: 'front',
        match_threshold: 0.85,
        auto_enrich: false,
        overwrite_existing: false,
        cache_duration_hours: 168,
      };

      // Update range value displays
      function updateRangeValues() {
        const rateLimitSlider = document.getElementById('api_rate_limit');
        const rateLimitValue = document.getElementById('rate_limit_value');
        rateLimitValue.textContent = rateLimitSlider.value;

        const thresholdSlider = document.getElementById('match_threshold');
        const thresholdValue = document.getElementById('threshold_value');
        thresholdValue.textContent = thresholdSlider.value;
      }

      // Add event listeners for range sliders
      document.getElementById('api_rate_limit').addEventListener('input', updateRangeValues);
      document.getElementById('match_threshold').addEventListener('input', updateRangeValues);

      // Fetch current configuration
      async function fetchConfig() {
        try {
          showMessage('Loading configuration...', 'info');
          const response = await fetch('/api/admin/plugins/musicbrainz_enricher/config');
          const data = await response.json();

          if (data.config) {
            populateForm(data.config);
          } else {
            populateForm(defaultConfig);
          }
          hideMessage();
        } catch (error) {
          console.error('Error fetching config:', error);
          showMessage('Failed to load configuration. Using defaults.', 'error');
          populateForm(defaultConfig);
        }
      }

      // Populate form with configuration data
      function populateForm(config) {
        document.getElementById('enabled').checked = config.enabled ?? defaultConfig.enabled;
        document.getElementById('api_rate_limit').value =
          config.api_rate_limit ?? defaultConfig.api_rate_limit;
        document.getElementById('user_agent').value = config.user_agent ?? defaultConfig.user_agent;
        document.getElementById('enable_artwork').checked =
          config.enable_artwork ?? defaultConfig.enable_artwork;
        document.getElementById('artwork_max_size').value =
          config.artwork_max_size ?? defaultConfig.artwork_max_size;
        document.getElementById('artwork_quality').value =
          config.artwork_quality ?? defaultConfig.artwork_quality;
        document.getElementById('match_threshold').value =
          config.match_threshold ?? defaultConfig.match_threshold;
        document.getElementById('auto_enrich').checked =
          config.auto_enrich ?? defaultConfig.auto_enrich;
        document.getElementById('overwrite_existing').checked =
          config.overwrite_existing ?? defaultConfig.overwrite_existing;
        document.getElementById('cache_duration_hours').value =
          config.cache_duration_hours ?? defaultConfig.cache_duration_hours;

        updateRangeValues();
      }

      // Handle form submission
      document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const config = {
          enabled: formData.get('enabled') === 'on',
          api_rate_limit: parseFloat(formData.get('api_rate_limit')),
          user_agent: formData.get('user_agent'),
          enable_artwork: formData.get('enable_artwork') === 'on',
          artwork_max_size: parseInt(formData.get('artwork_max_size')),
          artwork_quality: formData.get('artwork_quality'),
          match_threshold: parseFloat(formData.get('match_threshold')),
          auto_enrich: formData.get('auto_enrich') === 'on',
          overwrite_existing: formData.get('overwrite_existing') === 'on',
          cache_duration_hours: parseInt(formData.get('cache_duration_hours')),
        };

        try {
          const saveBtn = document.getElementById('save-btn');
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';

          const response = await fetch('/api/admin/plugins/musicbrainz_enricher/config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(config),
          });

          const result = await response.json();

          if (response.ok) {
            showMessage('Settings saved successfully!', 'success');
          } else {
            showMessage(result.error || 'Failed to save settings', 'error');
          }
        } catch (error) {
          showMessage(`Error: ${error.message}`, 'error');
        } finally {
          const saveBtn = document.getElementById('save-btn');
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Settings';
        }
      });

      // Reset to defaults
      function resetToDefaults() {
        if (confirm('This will reset all settings to their default values. Continue?')) {
          populateForm(defaultConfig);
          showMessage('Settings reset to defaults. Click "Save Settings" to apply.', 'info');
        }
      }

      // Test MusicBrainz connection
      async function testConnection() {
        try {
          showMessage('Testing MusicBrainz connection...', 'info');

          const response = await fetch('/api/admin/plugins/musicbrainz_enricher/search?q=test');

          if (response.ok) {
            showMessage('MusicBrainz connection test successful!', 'success');
          } else {
            showMessage('MusicBrainz connection test failed. Check your settings.', 'error');
          }
        } catch (error) {
          showMessage(`Connection test failed: ${error.message}`, 'error');
        }
      }

      // Show message
      function showMessage(message, type = 'info') {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.className =
          type === 'success' ? 'success-message' : type === 'error' ? 'error-message' : 'info-box';
        messageDiv.style.display = 'block';

        if (type === 'success' || type === 'info') {
          setTimeout(hideMessage, 5000);
        }
      }

      // Hide message
      function hideMessage() {
        const messageDiv = document.getElementById('message');
        messageDiv.style.display = 'none';
      }

      // Initialize settings page
      function initSettings() {
        fetchConfig();
        updateRangeValues();
      }

      // Initialize when page loads
      window.addEventListener('load', initSettings);
    </script>
  </body>
</html>
